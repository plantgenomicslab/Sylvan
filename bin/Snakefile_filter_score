import yaml, sys, re
from pathlib import Path

# Load config (reuse filter config)
config_path = Path("config_filter.yml")
try:
	with config_path.open() as f:
		config_dict = yaml.safe_load(f)
except yaml.YAMLError as e:
	sys.exit("Could not load configs! Check config_filter.yml ...")

image = config_dict["Singularity"]

# Derive prefix from anot_gff
pep_string = re.sub(r"\.fa.*$", "", config_dict["Input"]["anot_gff"] + ".fa")
pep_string = re.sub(r"^.*\/", "", pep_string)

rule all:
	input:
		"FILTER/scores.csv",
		"FILTER/scores.metrics.txt"

rule scoreModels:
	input:
		pfam = "FILTER/pfam.out",
		blast = "FILTER/BLASTP.OUT.TMP",
		blast_rex = "FILTER/BLASTP.OUT.Rex",
		rsem = "FILTER/rsem_outdir/RSEM.isoforms.results",
		cov_aug = "FILTER/augustus_coverage.bed",
		cov_helixer = "FILTER/helixer_coverage.bed",
		cov_repeat = "FILTER/repeat_coverage.bed",
		lnc_pred = "FILTER/lncrna_predict.csv",
		pep = f"FILTER/{pep_string}.pep"
	output:
		csv = "FILTER/scores.csv",
		metrics = "FILTER/scores.metrics.txt"
	singularity: image
	shell: """
		python bin/score_filter.py \
			--pfam {input.pfam} \
			--blast {input.blast} \
			--blast_rex {input.blast_rex} \
			--rsem {input.rsem} \
			--cov_aug {input.cov_aug} \
			--cov_helixer {input.cov_helixer} \
			--cov_repeat {input.cov_repeat} \
			--out_csv {output.csv} \
			--out_metrics {output.metrics}
		"""
