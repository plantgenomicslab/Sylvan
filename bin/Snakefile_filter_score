import yaml, sys, os, re
from pathlib import Path

# Results directory prefix - all outputs will be placed under this directory
RESULTS_DIR = "results/"

# Load config file (can be overridden via SYLVAN_FILTER_CONFIG environment variable)
config_file_path = os.environ.get('SYLVAN_FILTER_CONFIG', 'config_filter.yml')
try:
	with open(config_file_path, 'r') as f:
		config_dict = yaml.safe_load(f)
except yaml.YAMLError as e:
	sys.exit("Could not load configs! Check config_filter.yml ...")

image = config_dict["Singularity"]

# Derive prefix from anot_gff
pep_string = re.sub(r"\.fa.*$", "", config_dict["Input"]["anot_gff"] + ".fa")
pep_string = re.sub(r"^.*\/", "", pep_string)

os.makedirs(f"{RESULTS_DIR}logs", exist_ok=True)

rule all:
	input:
		f"{RESULTS_DIR}FILTER/scores.csv",
		f"{RESULTS_DIR}FILTER/scores.metrics.txt"

rule scoreModels:
	input:
		pfam = f"{RESULTS_DIR}FILTER/pfam.out",
		blast = f"{RESULTS_DIR}FILTER/BLASTP.OUT.TMP",
		blast_rex = f"{RESULTS_DIR}FILTER/BLASTP.OUT.Rex",
		rsem = f"{RESULTS_DIR}FILTER/rsem_outdir/RSEM.isoforms.results",
		cov_aug = f"{RESULTS_DIR}FILTER/augustus_coverage.bed",
		cov_helixer = f"{RESULTS_DIR}FILTER/helixer_coverage.bed",
		cov_repeat = f"{RESULTS_DIR}FILTER/repeat_coverage.bed",
		lnc_pred = f"{RESULTS_DIR}FILTER/lncrna_predict.csv",
		pep = f"{RESULTS_DIR}FILTER/{pep_string}.pep"
	output:
		csv = f"{RESULTS_DIR}FILTER/scores.csv",
		metrics = f"{RESULTS_DIR}FILTER/scores.metrics.txt"
	singularity: image
	shell: """
		python bin/score_filter.py \
			--pfam {input.pfam} \
			--blast {input.blast} \
			--blast_rex {input.blast_rex} \
			--rsem {input.rsem} \
			--cov_aug {input.cov_aug} \
			--cov_helixer {input.cov_helixer} \
			--cov_repeat {input.cov_repeat} \
			--out_csv {output.csv} \
			--out_metrics {output.metrics}
		"""
